blueprint:
  name: Automatic light deactivation with fade-out
  description: >
    Turns off lights when there is no motion for a configurable time or when it
    is bright enough. Uses a fade-out transition. If motion is detected during
    the fade, the activation blueprint will re-activate the lights using the
    appropriate scene (via the fade_flag). Requires a motion sensor (or group),
    an illuminance sensor, the target light(s), and an input_boolean helper
    used as "fade out progress" flag.
  domain: automation
  source_url: https://raw.githubusercontent.com/w-Teilchen/homeassistant_blueprints/refs/heads/main/light_deactivation_blueprint.yaml
  
  input:
    motion_sensor:
      name: Motion sensor or motion group
      description: >
        Binary_sensor that is ON when there is motion in the room (can be a group
        of multiple motion sensors).
      selector:
        entity:
          domain: binary_sensor
          device_class: occupancy

    delay:
      name: Delay before fading out the lights after no motion or enough brightness
      description: >
        How long there must be no motion before starting a fade-out.
      default: 00:01:00
      selector:
        duration: {}

    illuminance_sensor:
      name: Illuminance sensor
      description: >
        Sensor providing the room brightness in lux. If you want to use multiple
        sensors, create a template or min/avg helper sensor and use that here.
      selector:
        entity:
          domain: sensor
          device_class: illuminance

    brightness_threshold:
      name: Brightness threshold (lux)
      description: >
        When illuminance rises above this value, the lights will start to fade off.
      default: 60
      selector:
        number:
          min: 1
          max: 1000
          step: 1
          unit_of_measurement: lux
          mode: slider

    fade_flag:
      name: Fade-out-progress flag (input_boolean)
      description: >
        Input_boolean helper used internally to mark when an automatic fade-out
        is in progress. Create one helper per room and assign it here.
      selector:
        entity:
          domain: input_boolean

    snapshot_scene:
      name: Snapshot scene ID
      description: >
        A unique scene ID (e.g., "snapshot_living_room") used to capture the
        current light states before fading out. This allows the activation
        blueprint to restore the exact light states if they are turned on again
        shortly after the fade.
      default: snapshot_room
      selector:
        text: {}

    target_lights:
      name: Lights to snapshot and control
      description: >
        Light or light group that should be snapshot.
      selector:
        target:
          entity:
            domain: light

    off_transition:
      name: Off transition (seconds)
      description: >
        Duration of the fade-out when turning the lights off.
      default: 10
      selector:
        number:
          min: 0
          max: 300
          step: 1
          unit_of_measurement: seconds
          mode: slider

    fade_flag_buffer:
      name: Fade flag buffer time (seconds)
      description: >
        Extra time to keep the fade flag on after the fade-out completes.
        This ensures the activation blueprint can re-activate lights even
        if motion is detected slightly after the fade ends.
      default: 5
      selector:
        number:
          min: 0
          max: 30
          step: 1
          unit_of_measurement: seconds
          mode: slider

variables:
  off_transition: !input off_transition
  fade_flag_buffer: !input fade_flag_buffer

mode: restart
max_exceeded: silent

trigger:
  # 1) When there were no motion for the configured time
  - platform: state
    entity_id: !input motion_sensor
    to: "off"
    for: !input delay
    id: no_motion

  # 2) When it becomes bright enough
  - platform: numeric_state
    entity_id: !input illuminance_sensor
    above: !input brightness_threshold
    for: !input delay
    id: bright

condition: []

action:
  # Capture the current light states as a snapshot scene
  - service: scene.create
    data:
      scene_id: !input snapshot_scene
      snapshot_entities: !input target_lights

  # Mark that an automatic fade-out is in progress
  - service: input_boolean.turn_on
    target:
      entity_id: !input fade_flag

  # Start fading out the lights
  - service: light.turn_off
    target: !input target_lights
    data:
      transition: !input off_transition

  # Wait for transition + buffer time before clearing the flag
  # This allows the activation blueprint to re-activate lights
  # if motion is detected during or shortly after the fade
  - delay:
      seconds: "{{ (off_transition | int) + (fade_flag_buffer | int) }}"

  - service: input_boolean.turn_off
    target:
      entity_id: !input fade_flag
